<!-- Hero Section Begin -->
<%- include("../partials/heroSection",{allCategories:allCategories}) %>
<!-- Hero Section End -->


<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-section set-bg" data-setbg="/img/breadcrumb.jpg">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <div class="breadcrumb__text">
          <h2>BookWorm Shop</h2>
          <div class="breadcrumb__option">
            <a href="/">Home</a>
            <span>Shop</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Product Section Begin -->
<section class="product spad">
  <div class="container">
    <%if(allProducts.length>0){%>
    <div class="row">
      <div class="col-lg-3 col-md-5">
        <div class="sidebar">
          <div class="sidebar__item">
            <h4>Department</h4>
            <ul>
              <% allCategories.forEach((category)=>{ %>
              <li><a href="/shop/category/<%= category.categoryName %>/1"><%= category.categoryName %></a></li>
              <% }) %>
            </ul>
          </div>
          <div class="sidebar__item">
            <h4>Price</h4>
            <div class="price-range-wrap">
              <div class="price-range ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content" data-min="100" data-max="5000">
                <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
              </div>
              <div class="range-slider">
                <div class="price-input">
                  <input type="text" name="minPrice" id="minamount">
                  <input type="text" name="maxPrice" id="maxamount">
                  <button class="btn btn-sm" onclick="filterItems()" type="button"><i class="fa-solid fa-filter fa"></i></button>
                </div>
              </div>
            </div>
          </div>
          <div class="sidebar__item" id="latestProducts">
            <div class="latest-product__text">
              <h4>Latest Products</h4>
              <div class="latest-product__slider owl-carousel">
                <div class="latest-prdouct__slider__item">
                  <% latestProducts.slice(0,3).forEach((product)=> { %>
                    <% if (!product.isDeleted) { %> 
                  <a href="/product/<%= product.id %>" class="latest-product__item">
                    <div class="latest-product__item__pic">
                      <img src="/files/<%=product.productImagePath[0]%>" alt="">
                    </div>
                    <% if(product.discount){%>
                    <div class="latest-product__item__text">
                      <h6><%= product.name %></h6>
                      <h6><del><%=product.price  %></del></h6> <span>₹<%= product.offerPrice.toFixed(2) %></span>
                    </div>
                    <% }else{%>
                    <div class="latest-product__item__text">
                      <h6><%= product.name %></h6>
                      <span>₹<%= product.price %></span>
                    </div>
                    <% } %>
                  </a>
                  <% } %>
                  <% }) %>
                </div>
                <div class="latest-prdouct__slider__item">
                  <% latestProducts.slice(3,6).forEach((product)=> { %>
                    <% if (!product.isDeleted) { %> 
                  <a href="/product/<%= product.id %>" class="latest-product__item">
                    <div class="latest-product__item__pic">
                      <img src="/files/<%=product.productImagePath[0]%>" alt="">
                    </div>
                    <% if(product.discount){%>
                    <div class="latest-product__item__text">
                      <h6><%= product.name %></h6>
                      <h6><del><%=product.price  %></del></h6> <span>₹<%= product.offerPrice.toFixed(2) %></span>
                    </div>
                    <% }else{%>
                    <div class="latest-product__item__text">
                      <h6><%= product.name %></h6>
                      <span>₹<%= product.price %></span>
                    </div>
                    <% } %>
                  </a>
                  <% } %>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-9 col-md-7">
        <div class="product__discount" id="offerProducts">
          <div class="section-title product__discount__title">
            <h2>Sale Off</h2>
          </div>
          <div class="row">
            <div class="product__discount__slider owl-carousel">
              <% offerProducts.forEach(product=>{ %>
                <% if (!product.isDeleted) { %> 
              <div class="col-lg-4">
                <div class="product__discount__item">
                  <div class="product__discount__item__pic set-bg" data-setbg="/files/<%=product.productImagePath[0]  %>">
                    <div class="product__discount__percent">-<%= product.discount %>%</div>
                    <ul class="product__item__pic__hover">
                      <li><a onclick="wishlist('<%=product.name%>','<%=product.id%>')"><i class="fa fa-heart"></i></a></li>
                      <li><a onclick="addToCart('<%=product.id%>','<%=product.name%>','<%=product.price%>',1,'<%=product?.offerPrice%>')"><i class="fa fa-shopping-cart"></i></a></li>
                    </ul>
                  </div>
                  <div class="product__discount__item__text">
                    <!-- <span>Dried Fruit</span> -->
                    <h5><a href="/product/<%= product.id %>"><%= product.name %> </a></h5>
                    <div class="product__item__price"> ₹<%= product.offerPrice.toFixed(2)%><span>₹<%= product.price %> </span></div>
                  </div>
                </div>
              </div>
              <% } %>
              <%  }) %>
            </div>
          </div>
        </div>
        <div class="filter__item">
          <div class="row">
            <div class="col-lg-4 col-md-5">
              <div class="filter__sort">
                <span>Sort By</span>
                <select onchange="sortItems(this)">
                  <option value="latest">Latest</option>
                  <option id="sortMyItems" value="asc">Price asc</option>
                  <option value="dsc">Price dsc</option>
                </select>
              </div>
            </div>
            <div class="col-lg-4 col-md-4">
              <div class="filter__found">
                <h6><span><%= count %></span> Products found</h6>
              </div>
            </div>
            <div class="col-lg-4 col-md-3">
              <div class="filter__option">
                <span class="icon_grid-2x2"></span>
                <span class="icon_ul"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="row">

          <% allProducts.forEach((product)=>{%>
            <% if (!product.isDeleted) { %> 
          <div class="col-lg-4 col-md-6">
            <div class="product__item">
              <div class="product__item__pic set-bg" data-setbg="/files/<%= product.productImagePath[0] %>">
                <ul class="product__item__pic__hover">
                  <li><a onclick="wishlist('<%=product.name%>','<%=product.id%>')"><i class="fa fa-heart"></i></a></li>
                  <li><a onclick="addToCart('<%=product.id%>','<%=product.name%>','<%=product.price%>',1,'<%=product?.offerPrice%>')"><i class="fa fa-shopping-cart"></i></a></li>
                </ul>
              </div>
              <% if(product.discount){ %>
              <div class="product__discount__item__text">
                <h5><a href="/product/<%= product.id %>"><%= product.name %> </a></h5>
                <div class="product__item__price"> ₹<%= product.offerPrice.toFixed(2)%><span>₹<%= product.price %> </span></div>
              </div>
              <%  } else{ %>
              <div class="product__item__text">
                <h6><a href="/product/<%= product.id %>"><%= product.name %></a></h6>
                <h5>₹<%= product.price %></h5>
              </div>
              <%  } %>
            </div>
          </div>
          <% } %>
          <% }) %>
        </div>
        <!-- Product Section End -->
        <% if (limit > 0) { %>
        <div class="product__pagination">
          <% var i = (Number(current) > 5 ? Number(current) - 4 : 1) %>
          <% if (i !== 1) { %>
          <a class="pagination-block">...</a>
          <% } %>
          <% for (; i <= (Number(current) + 4) && i <= limit; i++) { %>
          <% if (i == current) { %>
          <a class="pagination-active"><%= i %></a>
          <% } else { %>
          <a href="/shop/<%= i %>?minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>&sort=<%= sortOrder %>"><%= i %></a>
          <% } %>
          <% if (i == Number(current) + 4 && i < limit) { %>
          <a class="pagination-block">...</a>
          <% } %>
          <% } %>
        </div>
        <% } %>
      </div>
      <%}else{%>
      <div class="col text-center">
        <div>
          <img src="/img/no_result.gif" alt="" width="600">
        </div>
        <a href="/" class="primary-btn">Go Home</a>
      </div>
      <%}%>
    </div>
  </div>
</section>

<script>

    function sortItems(sort){
    const sortOrder = sort.value
    const queryString = window.location.href;
    const currentLocation = window.location.pathname
    const urlParams = new URLSearchParams(queryString);
    const minPrice = urlParams.get("minPrice")?.split("₹").join("") || 100
    const maxPrice = urlParams.get("maxPrice")?.split("₹").join("") || 5000
    window.location =`/shop/1?minPrice=${minPrice}&maxPrice=${maxPrice}&sort=${sortOrder}`

  }
  function filterItems(filter){
    const minPrice = document.getElementById("minamount").value.split("₹").join("")
    const maxPrice = document.getElementById("maxamount").value.split("₹").join("")
    const currentLocation = window.location.pathname
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const sortOrder =urlParams.get("sort") || ""

    window.location =`/shop/1?minPrice=${minPrice}&maxPrice=${maxPrice}&sort=${sortOrder}`

    
  }

</script>

<script>

var rangeSlider = $(".price-range"),
minamount = $("#minamount"),
maxamount = $("#maxamount"),
minPrice = rangeSlider.data('min'),
maxPrice = rangeSlider.data('max');
rangeSlider.slider({
range: true,
min: minPrice,
max: maxPrice,
values: ['<%=minPrice%>', '<%=maxPrice%>'],
      slide: function (event, ui) {
      minamount.val('₹' + ui.values[0]);
      maxamount.val('₹' + ui.values[1]);
      }
      });
      minamount.val('₹' + rangeSlider.slider("values", 0));
      maxamount.val('₹' + rangeSlider.slider("values", 1));
      </script>